trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: k8s-common
  - name: helmRepoName
    value: 'online-store-charts'
  - name: chartName 
    value: 'order'
  - name: helmChartPath 
    value: './multi-helmchart/'
  - name: helmChartVersion
    value: '0.1.0'
  - name: imageTag
    value: $(Build.BuildId)
  - name: imageName
    value: 'order'

stages:
  - stage: Build
    displayName: Docker Build and Push
    jobs:
      - job: BuildPublishDockerImages
        displayName: Build nad push Docker Images
        steps:
          - template: appTemplates/build.yml
            parameters:
              acrServiceConnection: $(acrServiceConnection)
              imageName: $(imageName)
              dockerFilePath: '$(Build.sourcesdirectory)/app/order-service/Dockerfile'
              tag: $(imageTag)

  - stage: HelmPackagePush
    displayName: Helm Package and Push
    jobs:
    - job: Helm
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - template: appTemplates/helm-push.yml
          parameters:
            imageTag: $(imageTag)
            helmChartPath: $(helmChartPath)
            chartName: $(chartName)
            helmChartVersion: $(helmChartVersion) 
            helmRepoName: $(helmRepoName)
            acrName: $(acrName)
            serviceConnection: $(serviceConnection)
  
  - stage: Dev_Deploy
    displayName: Deploy to AKS Dev
    dependsOn: HelmPackagePush
    variables:
      - group: 'k8s-dev'
    jobs:
      - template: appTemplates/deploy.yml
        parameters:
            chartName: $(chartName)
            helmChartVersion: $(helmChartVersion) 
            helmRepoName: $(helmRepoName)
            acrName: $(acrName)
            aksCluster: $(aksCluster)
            aksResourceGroup: $(aksResourceGroup) 
            serviceConnection: $(serviceConnection)
            environment: dev
            namespace: $(namespace)
            helmChartPath: $(helmChartPath)
            imageTag: $(imageTag)

  - stage: Test_Deploy
    displayName: Deploy to AKS Test
    dependsOn: Dev_Deploy
    variables:
      - group: 'k8s-test'
    jobs:
      - template: appTemplates/deploy.yml
        parameters:
            chartName: $(chartName)
            helmChartVersion: $(helmChartVersion) 
            helmRepoName: $(helmRepoName)
            acrName: $(acrName)
            aksCluster: $(aksCluster)
            aksResourceGroup: $(aksResourceGroup) 
            serviceConnection: $(serviceConnection)
            environment: test
            namespace: $(namespace)
            helmChartPath: $(helmChartPath)
            imageTag: $(imageTag)

  - stage: Prod_Deploy
    displayName: Deploy to AKS Prod
    dependsOn: Test_Deploy
    variables:
      - group: 'k8s-prod'
    jobs:
      - template: appTemplates/deploy.yml
        parameters:
            chartName: $(chartName)
            helmChartVersion: $(helmChartVersion) 
            helmRepoName: $(helmRepoName)
            acrName: $(acrName)
            aksCluster: $(aksCluster)
            aksResourceGroup: $(aksResourceGroup) 
            serviceConnection: $(serviceConnection)
            environment: prod
            namespace: $(namespace)
            helmChartPath: $(helmChartPath)
            imageTag: $(imageTag)